name: Auto Renew Weirdhost

on:
  schedule:
    # åŒ—äº¬æ—¶é—´ 12:00 (ä¸­åˆ) = UTC 04:00
    - cron: '0 4 * * *'
    # å»ºè®®ï¼šå¢åŠ ä¸€æ¬¡è¿è¡Œä»¥é˜²ä¸‡ä¸€ (ä¾‹å¦‚åŒ—äº¬æ—¶é—´ 00:00 = UTC 16:00)
    # - cron: '0 4,16 * * *'
  workflow_dispatch:       # å…è®¸æ‰‹åŠ¨æŒ‰é’®è§¦å‘

jobs:
  renew:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    # æˆäºˆå†™å…¥ä»“åº“çš„æƒé™ï¼Œç”¨äºæ›´æ–° README
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: |
          sudo apt-get update
          # å®‰è£… xvfb å’Œä¸­æ—¥éŸ©å­—ä½“(é˜²æ­¢ä¹±ç )
          sudo apt-get install -y xvfb fonts-noto-cjk
          pip install playwright==1.52.0
          playwright install chromium --with-deps

      - name: Run Renew Script
        env:
          # ä» GitHub Secrets è¯»å–é…ç½®
          REMEMBER_WEB_COOKIE: ${{ secrets.REMEMBER_WEB_COOKIE }}
          PTERODACTYL_SESSION: ${{ secrets.PTERODACTYL_SESSION }}
          WEIRDHOST_EMAIL: ${{ secrets.WEIRDHOST_EMAIL }}
          WEIRDHOST_PASSWORD: ${{ secrets.WEIRDHOST_PASSWORD }}
          WEIRDHOST_SERVER_URLS: ${{ secrets.WEIRDHOST_SERVER_URLS }}
          
          # è®¾ç½®æ— å¤´æ¨¡å¼ä¸º false (é…åˆä¸‹é¢çš„ xvfb)
          HEADLESS: 'false'
          DISPLAY: ':99'
        run: |
          # å¯åŠ¨è™šæ‹Ÿæ˜¾ç¤ºå™¨
          Xvfb :99 -screen 0 1920x1080x24 &
          sleep 2
          # è¿è¡Œ Python è„šæœ¬
          python renew.py

      - name: Commit & Push README
        # å³ä½¿è„šæœ¬å¤±è´¥ä¹Ÿè¦æäº¤ README (è®°å½•å¤±è´¥çŠ¶æ€)
        if: always()
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # æ£€æŸ¥ README.md æ˜¯å¦æœ‰å˜åŠ¨
          if [[ -n $(git status -s README.md) ]]; then
            git add README.md
            git commit -m "ğŸ“ Update renewal status $(date +'%Y-%m-%d %H:%M')"
            git push
            echo "README.md updated and pushed."
          else
            echo "No changes to README.md."
          fi

      - name: Upload Debug Artifacts
        # åªæœ‰å¤±è´¥æ—¶æ‰ä¸Šä¼ æˆªå›¾ï¼Œä¿ç•™3å¤©
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: debug-screenshots
          path: screenshots/
          retention-days: 3
